{% extends "base.html" %}
{% block title %}Tableau des Charges{% endblock %}

{% block content %}
<div id="chargesContainer" class="w-[95%] mx-auto py-10">
  <!-- En-t√™te -->
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-4xl font-extrabold text-blue-700 flex items-center gap-2">
     <!-- <img src="{{ url_for('static', filename='img/charges_icon.png') }}" alt="" class="w-8 h-8">-->
      Tableau des Charges (Profils ‚Üî Phases)
    </h1>

    <div class="flex gap-3">
      <button onclick="toggleFullscreen()"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg shadow font-medium flex items-center gap-2">
        ‚õ∂ <span id="fsLabel">Plein √©cran</span>
      </button>

      <a href="{{ url_for('programme_config.exporter_tableau_charges', programme_id=request.view_args.programme_id) }}"
         class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg shadow font-medium flex items-center gap-2">
         üì§ Export Excel
      </a>

      <a href="{{ url_for('programme_config.liste_programmes') }}"
         class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2.5 rounded-lg shadow font-medium flex items-center gap-2">
         ‚¨Ö Retour
      </a>
    </div>
  </div>

  {% if not phases or not profils %}
  <div class="bg-yellow-50 border border-yellow-400 text-yellow-700 px-6 py-4 rounded-lg shadow mb-6 text-lg">
    ‚ö†Ô∏è Les phases et/ou profils ne sont pas encore d√©finis pour ce programme.
  </div>
  {% else %}

  <!-- Tableau invers√© -->
  <div class="overflow-x-auto bg-white rounded-2xl shadow-2xl border border-gray-200 p-2">
    <table class="min-w-[1200px] w-full text-base text-center border-collapse">
      <thead class="bg-gradient-to-r from-blue-700 to-blue-500 text-white">
        <tr>
          <th class="px-6 py-4 text-left text-lg">Profil</th>
          {% for phase in phases %}
          <th class="px-6 py-4">
            {{ phase.nom }}<br>
            <span class="text-xs font-normal">(Poids: {{ phase.poids|round(1) }}%)</span>
          </th>
          {% endfor %}
          <th class="px-6 py-4 text-lg">Total Profil</th>
        </tr>
      </thead>

      <tbody class="text-gray-800">
        {% for profil in profils %}
        <tr class="border-t hover:bg-gray-50 transition">
          <td class="px-6 py-4 font-semibold text-left">
            {{ profil.nom }}<br>
            <span class="text-xs text-gray-500">(Poids: {{ profil.poids|round(1) }}%)</span>
          </td>

          {% for phase in phases %}
            {% set charge = (phase.poids or 0) * (profil.poids or 0) / 100 %}
            <td class="px-6 py-3">{{ charge|round(2) }}%</td>
          {% endfor %}

          {# ‚úÖ Total Profil = poids du profil #}
          <td class="px-6 py-3 font-bold text-blue-700 bg-blue-50">
            {{ profil.poids|round(1) }}%
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot class="bg-gray-100 font-semibold text-gray-800 text-base border-t">
        <tr>
          <td class="px-6 py-4 text-right">Total Phase :</td>

          {# ‚úÖ Total Phase = poids de la phase #}
          {% for phase in phases %}
            <td class="px-6 py-4">{{ phase.poids|round(1) }}%</td>
          {% endfor %}

          <td class="px-6 py-4 bg-blue-100 text-blue-700 font-bold">100%</td>
        </tr>
      </tfoot>
    </table>
  </div>

  {% endif %}
</div>

<!-- üîπ Script plein √©cran -->
<script>
function toggleFullscreen() {
  const elem = document.getElementById('chargesContainer');
  const label = document.getElementById('fsLabel');

  if (!document.fullscreenElement) {
    elem.requestFullscreen()
      .then(() => {
        label.textContent = "Quitter";
        elem.classList.add("max-h-[100vh]");
        elem.classList.add("overflow-auto");
      })
      .catch(err => console.error("Erreur plein √©cran :", err));
  } else {
    document.exitFullscreen()
      .then(() => {
        label.textContent = "Plein √©cran";
        elem.classList.remove("max-h-[100vh]");
      })
      .catch(err => console.error("Erreur sortie plein √©cran :", err));
  }
}
</script>
{% endblock %}
