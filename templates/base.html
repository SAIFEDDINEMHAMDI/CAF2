<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}2025 - Application{% endblock %}</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  {% block styles %}{% endblock %}
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex">

  <!-- ===========================
       üîπ SIDEBAR
  ============================ -->
  <aside id="sidebar" class="w-64 bg-biat-primary text-white min-h-screen transition-all duration-300 flex-shrink-0 fixed left-0 top-0 z-40">
    <div class="p-6 border-b border-biat-secondary/20">
      <div class="flex items-center space-x-3">
        <img src="{{ url_for('static', filename='img/biatit.png') }}" alt="Logo BIAT IT" class="h-8">
      </div>
    </div>

    <!-- üîπ Toast container -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="toast px-6 py-5 rounded shadow-lg text-base flex items-center space-x-2 border-l-4 transform transition-all duration-500 translate-x-5 opacity-0
              {% if category == 'error' %} bg-red-50 text-red-800 border-red-500
              {% elif category == 'success' %} bg-green-50 text-green-800 border-green-500
              {% elif category == 'warning' %} bg-yellow-50 text-yellow-800 border-yellow-500
              {% else %} bg-blue-50 text-blue-800 border-blue-500 {% endif %}">
              <span>{{ message }}</span>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const toasts = document.querySelectorAll(".toast");
        toasts.forEach((toast, index) => {
          setTimeout(() => {
            toast.classList.remove("translate-x-5", "opacity-0");
            toast.classList.add("translate-x-0", "opacity-100");
          }, 100 + index * 100);
          setTimeout(() => {
            toast.classList.remove("translate-x-0", "opacity-100");
            toast.classList.add("translate-x-5", "opacity-0");
            setTimeout(() => toast.remove(), 500);
          }, 6000 + index * 200);
        });
      });
    </script>

    <!-- ===========================
         üîπ MENU COMPLET
    ============================ -->
    <nav class="mt-4">
      <ul class="space-y-1 px-4">

        <!-- üî∏ Administration -->
        <li>
          <button onclick="toggleAdminMenu()" class="w-full flex items-center justify-between p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition focus:outline-none">
            <span class="flex items-center space-x-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
              <span>Administration</span>
            </span>
            <svg id="admin-arrow" xmlns="http://www.w3.org/2000/svg"
                 class="h-4 w-4 transform transition-transform duration-300"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <ul id="admin-submenu" class="ml-8 mt-1 overflow-hidden max-h-0 transition-all duration-500 ease-in-out">
            <li><a href="{{ url_for('valeurs_metier.liste_valeurs') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">Co√ªt de retard IT For IT</a></li>
            <li><a href="{{ url_for('complexite.liste_complexite') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">Complexit√©</a></li>
            <li><a href="{{ url_for('statut_demande.liste_statuts') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">Statut des Demandes</a></li>
            <li><a href="{{ url_for('phase.liste_phases') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">Phase d'un programme</a></li>
            <li><a href="{{ url_for('programme_config.liste_programmes') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">Programmes</a></li>
            <li><a href="{{ url_for('domaines.liste_domaines') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">Domaine d'activit√©</a></li>
            <li><a href="{{ url_for('regles_complexite.liste_regles') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">R√®gles de Complexit√©</a></li>
            <li><a href="{{ url_for('affectation.liste_affectation') }}" class="flex items-center space-x-3 p-2 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">Affectation</a></li>
          </ul>
        </li>

        <script>
          function toggleAdminMenu() {
            const submenu = document.getElementById("admin-submenu");
            const arrow = document.getElementById("admin-arrow");
            submenu.classList.toggle("max-h-0");
            submenu.classList.toggle("max-h-96");
            arrow.classList.toggle("rotate-180");
          }
        </script>

        <!-- üî∏ Autres menus -->
 <li><a href="{{ url_for('caf.caf_automatique') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6h6zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10h4V9a2 2 0 00-2-2H9z"/>
  </svg>
  <span>CAF Disponible</span>
</a></li>

<li><a href="{{ url_for('caf.caf_requise') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M16 8v8m-4-5v5m-4-2v2m12-6v10H6V6h10z"/>
  </svg>
  <span>Vue par Semaine</span>
</a></li>

<li><a href="{{ url_for('caf.caf_disponibles') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M13 10V3L4 14h7v7l9-11h-7z"/>
  </svg>
  <span>Build & Run</span>
</a></li>

<li><a href="{{ url_for('collaborateurs.liste_collaborateurs') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1z"/>
  </svg>
  <span>Collaborateurs</span>
</a></li>

<li><a href="{{ url_for('accompagnement.liste_accompagnement') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M17 16v2a2 2 0 01-2 2H5V6a2 2 0 012-2h10v2"/>
  </svg>
  <span>Accompagnement externe</span>
</a></li>

<li><a href="{{ url_for('recrutement.liste_recrutement') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 13l4 4L19 7"/>
  </svg>
  <span>Recrutement</span>
</a></li>

<li><a href="{{ url_for('profils.liste_profils') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7V5h5.586l5.414 5.414V21z"/>
  </svg>
  <span>Profils</span>
</a></li>

<li><a href="{{ url_for('projet.liste_projets') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 17v-2m3 2v-4m3 4v-6M7 3h10v18H7z"/>
  </svg>
  <span>Liste des projets</span>
</a></li>

<li><a href="{{ url_for('projet.liste_demandes') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 17v-2m3 2v-4m3 4v-6M7 3h10v18H7z"/>
  </svg>
  <span>Liste des demandes</span>
</a></li>

<li><a href="{{ url_for('demande_it.liste_demandes_it') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 17v-2m3 2v-4m3 4v-6M7 3h10v18H7z"/>
  </svg>
  <span>Liste des demandes IT</span>
</a></li>

<li><a href="{{ url_for('demande_it.liste_projets_it') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 17v-2m3 2v-4m3 4v-6M7 3h10v18H7z"/>
  </svg>
  <span>Liste des projets IT</span>
</a></li>

<li><a href="{{ url_for('caf.caf_dashboard') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 17v-2m3 2v-4m3 4v-6M7 3h10v18H7z"/>
  </svg>
  <span>Dashboard CAF</span>
</a></li>

<li><a href="{{ url_for('projet.demandes_retenues') }}" class="flex items-center space-x-3 p-3 rounded hover:bg-biat-secondary/20 hover:text-biat-secondary transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 17v-2m3 2v-4m3 4v-6M7 3h10v18H7z"/>
  </svg>
  <span>Demandes chiffr√©es (√† retenir)</span>
</a></li>


      </ul>
    </nav>
  </aside>

  <!-- ===========================
       üîπ CONTENU PRINCIPAL
  ============================ -->
  <div id="main-content-wrapper" class="flex-1 min-h-screen flex flex-col transition-margin duration-300 ml-64">
    <header class="bg-white shadow-sm border-b px-6 py-4 flex items-center justify-between">
      <button id="toggle-sidebar" class="text-gray-700 focus:outline-none focus:ring-2 focus:ring-biat-secondary/50 p-1 rounded">
        <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      {% set user = ui_user or session.user %}
      <div class="flex items-center space-x-6">
        {% if user %}
          <span class="text-sm text-gray-600 flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            {% set display_name = ((user.prenom or '') ~ ' ' ~ (user.nom or '')).strip() %}
            <span>{{ display_name or user.username or user.email or 'Utilisateur' }}</span>
          </span>
          <a href="{{ url_for('auth.logout') }}" class="text-sm text-red-600 hover:text-red-800 font-medium">D√©connexion</a>
        {% else %}
          <a href="{{ url_for('auth.login') }}" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Connexion</a>
        {% endif %}
      </div>
    </header>

    <main id="main-content" class="container mx-auto mt-6 px-6 flex-grow">
      {% block content %}{% endblock %}
    </main>

    <footer class="bg-white border-t py-4 px-6 text-center text-sm text-gray-600">
      ¬© 2025 BIAT IT - All Rights Reserved
    </footer>
  </div>

  <!-- ===========================
       üîπ JS G√âN√âRAL
  ============================ -->
  <script>
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("toggle-sidebar");
    const toggleIcon = document.getElementById("toggle-icon");
    const mainWrapper = document.getElementById("main-content-wrapper");
    const isHidden = localStorage.getItem("sidebar-hidden") === "true";

    if (isHidden) {
      sidebar.classList.add("-ml-64");
      mainWrapper.classList.replace("ml-64", "ml-0");
      toggleIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 19l-7-7 7-7" />`;
    }

    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("-ml-64");
      mainWrapper.classList.toggle("ml-64");
      mainWrapper.classList.toggle("ml-0");
      const hidden = sidebar.classList.contains("-ml-64");
      toggleIcon.innerHTML = hidden
        ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 19l-7-7 7-7" />`
        : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />`;
      localStorage.setItem("sidebar-hidden", hidden);
    });

    tailwind.config = {
      theme: {
        extend: {
          colors: {
            biat: { primary: '#003366', secondary: '#0066CC', light: '#E6F0FF' }
          }
        }
      }
    };
  </script>

  <!-- ===========================
       üîí AUTO-LOGOUT + TOKEN CHECK
  ============================ -->
  <script>
    let inactivityTimeout;
    const MAX_INACTIVITY_MINUTES = 15;
    const CHECK_INTERVAL = 30000;

    function showSessionExpiredToast() {
      const toast = document.createElement("div");
      toast.className = "px-6 py-4 rounded shadow-lg bg-yellow-50 text-yellow-800 border-l-4 border-yellow-500 fixed top-4 right-4 z-50 transition-all duration-300";
      toast.textContent = "‚è∞ Votre session a expir√©. Redirection vers la connexion...";
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    function redirectToLogin() {
      showSessionExpiredToast();
      setTimeout(() => window.location.href = "{{ url_for('auth.logout') }}", 2000);
    }

    function resetInactivityTimer() {
      clearTimeout(inactivityTimeout);
      inactivityTimeout = setTimeout(redirectToLogin, MAX_INACTIVITY_MINUTES * 60000);
    }

    ["mousemove", "keydown", "click", "scroll"].forEach(event => document.addEventListener(event, resetInactivityTimer));
    resetInactivityTimer();

    async function checkTokenValidity() {
      try {
        const response = await fetch("{{ url_for('auth.token_info') }}");
        if (!response.ok) redirectToLogin();
      } catch {
        redirectToLogin();
      }
    }
    setInterval(checkTokenValidity, CHECK_INTERVAL);
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
