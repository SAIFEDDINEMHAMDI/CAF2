{% extends "base.html" %}
{% block title %}CAF Disponible{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-6 py-8">

  <!-- üîπ Titre et actions -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-gray-700" fill="none" stroke="currentColor" stroke-width="2"
           viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round"
           d="M4 6h16M4 12h16M4 18h16"/></svg>
      CAF Disponible par Collaborateur
    </h1>

    <div class="flex flex-wrap items-center gap-3">
      <!-- Plein √©cran -->
      <button id="fullscreen-btn"
              class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-full shadow-md flex items-center gap-2 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round"
             d="M4 8V4h4M4 4l6 6m10 6v4h-4m4 0l-6-6"/></svg>
        Plein √©cran
      </button>

      <!-- Export Excel -->
      <a href="{{ url_for('caf.export_excel') }}"
         class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full shadow-md flex items-center gap-2 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round"
             d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        Exporter Excel
      </a>
    </div>
  </div>

  <!-- üîç Barre de recherche -->
  <form method="get" class="flex items-center mb-6 gap-2">
    <input type="text" name="search" value="{{ search }}" placeholder="üîç Rechercher (nom, profil, affectation...)"
           class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-80 focus:ring-gray-400 focus:border-gray-400">
    <button type="submit" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md shadow transition">Filtrer</button>
  </form>

  <!-- üîπ Tableau principal -->
  <div id="caf-container" class="overflow-x-auto bg-gray-50 rounded-lg border border-gray-200 shadow">
    <table class="min-w-full border-collapse text-sm">
      <thead class="bg-gray-100 text-gray-700 text-xs uppercase">
        <tr>
          <th class="px-3 py-3 text-left font-semibold">Matricule</th>
          <th class="px-3 py-3 text-left font-semibold">Nom & Pr√©nom</th>
          <th class="px-3 py-3 text-left font-semibold">Profil</th>
          <th class="px-3 py-3 text-left font-semibold">Affectation</th>
          <th class="px-3 py-3 text-center font-semibold">%Build</th>
          <th class="px-3 py-3 text-center font-semibold">%Run</th>
          <th class="px-3 py-3 text-center font-semibold">CAF Build</th>
          <th class="px-3 py-3 text-center font-semibold">CAF Run</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
  {% for c in collaborateurs %}
  <tr
    class="transition align-top cursor-pointer
           {% if c.repartitions and c.repartitions|length > 0 %}
             bg-blue-50 hover:bg-blue-100
           {% else %}
             hover:bg-gray-50
           {% endif %}"
    onclick="openProfilModal('{{ c.matricule }}', '{{ c.nom_prenom }}')"
  >
    <td class="px-3 py-3 font-semibold text-gray-800">{{ c.matricule }}</td>
    <td class="px-3 py-3 text-left">{{ c.nom_prenom }}</td>
    <td class="px-3 py-3">{{ c.profil }}</td>
    <td class="px-3 py-3 text-gray-600">{{ c.affectation }}</td>
    <td class="px-3 py-3 text-center text-gray-700">{{ "%.0f"|format(c.build_ratio) }}%</td>
    <td class="px-3 py-3 text-center text-gray-700">{{ "%.0f"|format(c.run_ratio) }}%</td>
    <td class="px-3 py-3 text-center font-semibold text-gray-800">
      <div class="flex flex-col items-center leading-tight">
        <span>{{ "%.1f"|format(c.caf_disponible_build) }}</span>
        <span class="text-[10px] text-gray-400">JH</span>
      </div>
    </td>
    <td class="px-3 py-3 text-center font-semibold text-gray-800">
      <div class="flex flex-col items-center leading-tight">
        <span>{{ "%.1f"|format(c.caf_disponible_run) }}</span>
        <span class="text-[10px] text-gray-400">JH</span>
      </div>
    </td>
  </tr>
  {% endfor %}
</tbody>

    </table>
  </div>

  <!-- üîπ Pagination -->
  <div class="flex justify-center items-center gap-2 mt-6">
    {% if page > 1 %}
      <a href="{{ url_for('caf.caf_disponibles', page=page-1, search=search) }}"
         class="px-3 py-2 border rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700">‚Üê Pr√©c√©dent</a>
    {% endif %}

    <span class="px-3 py-2 text-sm text-gray-600">Page {{ page }} / {{ total_pages }}</span>

    {% if page < total_pages %}
      <a href="{{ url_for('caf.caf_disponibles', page=page+1, search=search) }}"
         class="px-3 py-2 border rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700">Suivant ‚Üí</a>
    {% endif %}
  </div>
</div>

<!-- üîπ MODALE PROFILS SECONDAIRES -->
<div id="profilModal"
     class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 transition-opacity duration-300 ease-out opacity-0">
  <div id="profilModalContent"
       class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-6 transform scale-95 transition-all duration-300 ease-out">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 id="modalTitle" class="text-xl font-semibold text-blue-600">Profils secondaires</h2>
      <button onclick="closeProfilModal()" class="text-gray-500 hover:text-gray-700 text-lg font-bold">√ó</button>
    </div>
    <!-- Content -->
    <div id="modalContent" class="overflow-x-auto max-h-96">
      <p class="text-center text-gray-500 italic">Chargement...</p>
    </div>
  </div>
</div>

<script>
  // ‚úÖ Ouvrir la modale avec zoom + chargement AJAX
  async function openProfilModal(matricule, nomPrenom) {
    const modal = document.getElementById('profilModal');
    const content = document.getElementById('profilModalContent');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalContent');

    title.textContent = `Profils secondaires - ${nomPrenom}`;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
      modal.classList.add('opacity-100');
      modal.classList.remove('opacity-0');
      content.classList.remove('scale-95');
      content.classList.add('scale-100');
    }, 20);

    body.innerHTML = '<p class="text-center text-gray-500 italic">Chargement...</p>';

    try {
      const res = await fetch(`/caf/profils_secondaires/${matricule}`);
      const data = await res.json();

      if (data.success && data.profils.length > 0) {
        let rows = `
          <table class="min-w-full text-sm border border-gray-200 rounded-lg">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Profil</th>
                <th class="px-4 py-2 text-center font-medium text-gray-700">% Build</th>
                <th class="px-4 py-2 text-center font-medium text-gray-700">% Run</th>
                <th class="px-4 py-2 text-center font-medium text-gray-700">JH Build</th>
                <th class="px-4 py-2 text-center font-medium text-gray-700">JH Run</th>
              </tr>
            </thead>
            <tbody>
        `;
        data.profils.forEach(p => {
          rows += `
            <tr class="hover:bg-gray-50 transition">
              <td class="px-4 py-2 text-gray-800">${p.profil}</td>
              <td class="px-4 py-2 text-center">${p.pct_build}%</td>
              <td class="px-4 py-2 text-center">${p.pct_run}%</td>
              <td class="px-4 py-2 text-center">${p.jh_build}</td>
              <td class="px-4 py-2 text-center">${p.jh_run}</td>
            </tr>`;
        });
        rows += "</tbody></table>";
        body.innerHTML = rows;
      } else {
        body.innerHTML = `<p class="text-center text-gray-500 italic">Aucun profil secondaire trouv√©.</p>`;
      }
    } catch (err) {
      body.innerHTML = `<p class="text-center text-red-500 italic">Erreur lors du chargement.</p>`;
    }
  }

  // ‚úÖ Fermer la modale avec effet smooth
  function closeProfilModal() {
    const modal = document.getElementById('profilModal');
    const content = document.getElementById('profilModalContent');

    modal.classList.add('opacity-0');
    modal.classList.remove('opacity-100');
    content.classList.add('scale-95');
    content.classList.remove('scale-100');

    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 250);
  }

  // üîπ Plein √©cran (inchang√©)
  const container = document.getElementById("caf-container");
  const btn = document.getElementById("fullscreen-btn");
  btn.addEventListener("click", () => {
    if (!document.fullscreenElement) {
      container.requestFullscreen();
      btn.innerHTML = 'Quitter plein √©cran';
    } else {
      document.exitFullscreen();
      btn.innerHTML = 'Plein √©cran';
    }
  });
</script>
{% endblock %}
