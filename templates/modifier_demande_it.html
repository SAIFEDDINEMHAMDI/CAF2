{% extends "base.html" %}
{% block title %}Modifier la demande{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-8 py-10">
  <h1 class="text-3xl font-bold mb-6 text-blue-600">Modifier la demande IT</h1>

  <!-- ============================= -->
  <!-- AFFICHAGE DES MESSAGES FLASH -->
  <!-- ============================= -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="px-4 py-3 rounded-lg text-white
                      {% if category == 'success' %}bg-green-600
                      {% elif category == 'error' %}bg-red-600
                      {% elif category == 'warning' %}bg-yellow-500
                      {% else %}bg-blue-500{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ================================================== -->
  <!-- üîπ BLOC 1Ô∏è‚É£ : INFORMATIONS G√âN√âRALES -->
  <!-- ================================================== -->
  <form method="POST" class="bg-white shadow-md rounded-lg p-6 mb-10 border border-gray-200">
    <h2 class="text-2xl font-semibold text-blue-600 mb-4">Informations g√©n√©rales</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block font-medium text-gray-700 mb-1">Titre</label>
        <input type="text" name="titre" value="{{ demande.titre_projet }}"
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
      </div>

      <div>
        <label class="block font-medium text-gray-700 mb-1">Description</label>
        <textarea name="description" rows="2"
                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">{{ demande.description }}</textarea>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
      <div>
        <label class="block font-medium text-gray-700 mb-1">Programme</label>
        <select name="id_programme"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
          <option value="">-- S√©lectionner un programme --</option>
          {% for prog in programmes %}
            <option value="{{ prog.id }}" {% if prog.id == demande.id_programme %}selected{% endif %}>
              {{ prog.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block font-medium text-gray-700 mb-1">Domaine</label>
        <select name="id_domaine"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
          <option value="">-- S√©lectionner un domaine --</option>
          {% for d in domaines %}
            <option value="{{ d.id }}" {% if d.id == demande.id_domaine %}selected{% endif %}>
              {{ d.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

<div>
  <label class="block font-medium text-gray-700 mb-1">Statut</label>

  {% if statut_demande.nom_statut_demande == 'Chiffr√©' %}
    <!-- üîπ Statut modifiable -->
    <select id="statutSelect" name="statut"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
      <option value="">-- S√©lectionner un statut --</option>
      {% for s in statuts %}
        <option value="{{ s.id }}" {% if s.id == demande.retenue %}selected{% endif %}>
          {{ s.nom }}
        </option>
      {% endfor %}
    </select>
    <p class="text-sm text-green-600 mt-1">üü¢ Ce projet est chiffr√© ‚Äî modification autoris√©e.</p>
  {% else %}
    <!-- üîí Statut lecture seule -->
    <select id="statutSelect" name="statut" disabled
            class="w-full border border-gray-200 bg-gray-100 rounded-lg px-4 py-2 text-gray-600 cursor-not-allowed">
      <option value="">-- S√©lectionner un statut --</option>
      {% for s in statuts %}
        <option value="{{ s.id }}" {% if s.id == demande.retenue %}selected{% endif %}>
          {{ s.nom }}
        </option>
      {% endfor %}
    </select>
    <p class="text-sm text-gray-500 mt-1">üîí Modification du statut d√©sactiv√©e (non chiffr√©).</p>
  {% endif %}
</div>


      <div>
        <label class="block font-medium text-gray-700 mb-1">Date MEP</label>
        <input type="date" name="date_mep" value="{{ demande.date_mep or '' }}"
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
      </div>
    </div>
<div class="mt-6">
    <label class="block font-medium text-gray-700 mb-1">Statut de la Demande</label>
    <input type="text"
           value="{% if statut_demande.nom_statut_demande %}{{ statut_demande.nom_statut_demande }}{% else %}NA{% endif %}"
           readonly
           class="w-full md:w-1/3 border border-gray-300 bg-gray-100 rounded-lg px-4 py-2 text-gray-600 cursor-not-allowed">
  </div>
    <div class="mt-8">
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg">
        üíæ Enregistrer les informations
      </button>
      <a href="{{ url_for('demande_it.liste_demandes_it') }}"
         class="ml-4 text-blue-600 hover:underline">‚Üê Retour</a>
    </div>
  </form>

<!-- ================================================== -->
<!-- üîπ BLOC : VALEURS M√âTIER-->
<!-- ================================================== -->
<form method="POST" action="{{ url_for('demande_it.update_all_valeurs_metier_it', projet_id=demande.id) }}"
      class="bg-white shadow-md rounded-lg border border-gray-200 mb-10" id="form-valeurs">
  <h2 class="text-2xl font-semibold text-blue-600 px-6 pt-6 mb-4">Valeurs m√©tier</h2>

  <table class="min-w-full border border-gray-300 rounded-lg mb-4">
    <thead class="bg-blue-600 text-white">
      <tr>
        <th class="px-4 py-2 text-left w-1/3">Libell√©</th>
        <th class="px-4 py-2 text-left w-1/3">Type</th>
        <th class="px-4 py-2 text-left w-1/3">Valeur</th>
      </tr>
    </thead>
    <tbody>
      {% for valeur in valeurs %}
      <tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-2 font-medium text-gray-800">{{ valeur.libelle }}</td>

        <!-- üîπ TYPE -->
        <td class="px-4 py-2">
          <select id="type_{{ loop.index }}"
                  name="type_{{ valeur.libelle }}"
                  class="border border-gray-300 rounded-lg px-3 py-1 w-full"
                  onchange="updateValeurs('{{ loop.index }}', '{{ valeur.libelle }}')">
            <option value="">-- S√©lectionner --</option>
            {% for opt in dropdowns[valeur.libelle] | groupby('type_libelle') %}
              <option value="{{ opt.grouper }}" {% if opt.grouper == valeur.type_libelle %}selected{% endif %}>
                {{ opt.grouper }}
              </option>
            {% endfor %}
          </select>
        </td>

        <!-- üîπ VALEUR -->
        <td class="px-4 py-2">
          <select name="valeur_{{ valeur.libelle }}" id="valeur_{{ loop.index }}"
                  class="border border-gray-300 rounded-lg px-3 py-1 w-full">
            {% for option in dropdowns[valeur.libelle] if option.type_libelle == valeur.type_libelle %}
              <option value="{{ option.id }}" {% if option.id == valeur.id_valeur_metier %}selected{% endif %}>
                {{ option.valeur_libelle }}
              </option>
            {% endfor %}
          </select>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
<div class="px-6 py-4 bg-gray-50 border-t flex justify-between text-2xl text-gray-800 font-medium">
  <div><strong>üí° Score total des valeurs m√©tier :</strong> {{ demande.score_valeur_metier or 0 }}</div>
</div>

  <div class="px-6 pb-6 mt-4">
    <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg">
      üíæ Enregistrer toutes les valeurs m√©tier
    </button>
  </div>
</form>

  <!-- =================================================== -->
  <!-- üîπ BLOC 2Ô∏è‚É£ : COMPLEXIT√â DE LA DEMANDE -->
  <!-- =================================================== -->
  <form method="POST" action="{{ url_for('demande_it.update_all_complexites_demande_it', projet_id=demande.id) }}"
        class="bg-white shadow-md rounded-lg border border-gray-200 mt-10" id="form-complexite">
    <h2 class="text-2xl font-semibold text-blue-600 px-6 pt-6 mb-4">Complexit√© de la demande</h2>

    <table class="min-w-full border border-gray-300 rounded-lg mb-4">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="px-4 py-2 text-left w-1/3">Libell√©</th>
          <th class="px-4 py-2 text-left w-1/3">Type</th>
          <th class="px-4 py-2 text-left w-1/3">Valeur</th>
        </tr>
      </thead>
      <tbody>
        {% for comp in complexites %}
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2 font-medium text-gray-800">{{ comp.libelle }}</td>
          <td class="px-4 py-2">
            <select id="type_c{{ loop.index }}" class="border border-gray-300 rounded-lg px-3 py-1 w-full"
                    onchange="updateComplexite('{{ loop.index }}')">
              <option value="">-- S√©lectionner --</option>
              {% for opt in dropdowns_complexite[comp.libelle] | groupby('type_libelle') %}
                <option value="{{ opt.grouper }}" {% if opt.grouper == comp.type_libelle %}selected{% endif %}>
                  {{ opt.grouper }}
                </option>
              {% endfor %}
            </select>
          </td>
          <td class="px-4 py-2">
            <select name="complexite_{{ comp.libelle }}" id="valeur_c{{ loop.index }}"
                    class="border border-gray-300 rounded-lg px-3 py-1 w-full">
              <option value="">-- S√©lectionner --</option>
              {% for option in dropdowns_complexite[comp.libelle] if option.type_libelle == comp.type_libelle %}
                <option value="{{ option.id }}" {% if option.id == comp.id_complexite %}selected{% endif %}>
                  {{ option.valeur_libelle }}
                </option>
              {% endfor %}
            </select>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
<!-- ================================================= -->
<!-- üü° MODAL DE CONFIRMATION PARTIELLE -->
<!-- ================================================= -->
<div id="modalPartial" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full text-center">
    <h2 class="text-xl font-semibold text-gray-800 mb-3">‚ö†Ô∏è Chiffrage partiel d√©tect√©</h2>
    <p class="text-gray-600 mb-6">
      Vous avez rempli <span id="rempliesCount" class="font-bold text-blue-600"></span> /
      <span id="totalCount" class="font-bold"></span> complexit√©s.<br>
      La demande sera marqu√©e comme <b>partiellement chiffr√©e</b>.<br><br>
      Souhaitez-vous continuer ?
    </p>

    <div class="flex justify-center gap-4">
     <button id="confirmPartial" type="button"
        class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 shadow">
  ‚úÖ Continuer
</button>
<button id="cancelPartial" type="button"
        class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-400 shadow">
  ‚ùå Annuler
</button>

    </div>
  </div>
</div>

    <!-- ‚úÖ AFFICHAGE SCORE ET JH ESTIM√â -->
<div class="px-6 py-4 bg-gray-50 border-t flex justify-between text-2xl text-gray-800 font-medium">
  <div><strong>‚öôÔ∏è Score de complexit√© :</strong> {{ demande.score_complexite or 0 }}</div>
  <div><strong>üìä JH estim√© :</strong> {{ demande.estimation_jh or 0 }} JH</div>
</div>

    <div class="px-6 pb-6 mt-4">
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg">
        üíæ Enregistrer toutes les complexit√©s
      </button>
    </div>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script defer>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector('form[action*="update_all_complexites_demande_it"]');
  const modal = document.getElementById("modalPartial");
  const confirmBtn = document.getElementById("confirmPartial");
  const cancelBtn = document.getElementById("cancelPartial");
  const rempliesEl = document.getElementById("rempliesCount");
  const totalEl = document.getElementById("totalCount");
  const statutSelect = document.getElementById("statutSelect");

  if (!form || !modal) return;
  let shouldSubmit = false;

  // ‚úÖ Fonction de mise √† jour automatique du statut
  function majStatutAuto() {
    const selects = form.querySelectorAll("select[name^='complexite_']");
    const total = selects.length;
    const remplies = Array.from(selects).filter(s => s.value && s.value.trim() !== "").length;

    if (!statutSelect) return;
    if (statutSelect.dataset.userModified === "true") return;

    let newValue = "";
    if (remplies === total) {
      newValue = Array.from(statutSelect.options).find(o => o.text.toLowerCase().includes("chiffr√©"))?.value;
    } else if (remplies > 0 && remplies < total) {
      newValue = Array.from(statutSelect.options).find(o => o.text.toLowerCase().includes("partiel"))?.value;
    } else {
      newValue = Array.from(statutSelect.options).find(o => o.text.toLowerCase().includes("non"))?.value;
    }

    if (newValue) statutSelect.value = newValue;
  }

  // ‚úÖ Marquer si l‚Äôutilisateur modifie le statut manuellement
  statutSelect?.addEventListener("change", () => {
    statutSelect.dataset.userModified = "true";
  });

  // ‚úÖ Gestion de la soumission du formulaire
  form.addEventListener("submit", (e) => {
    majStatutAuto();
    if (shouldSubmit) return;

    const selects = form.querySelectorAll("select[name^='complexite_']");
    const total = selects.length;
    const remplies = Array.from(selects).filter(s => s.value && s.value.trim() !== "").length;

    if (remplies === total) {
      alert("‚úÖ Toutes les complexit√©s sont renseign√©es. La demande sera marqu√©e comme CHIFFR√âE.");
      return;
    }

    if (remplies > 0 && remplies < total) {
      e.preventDefault();
      rempliesEl.textContent = remplies;
      totalEl.textContent = total;
      modal.classList.remove("hidden");
      return;
    }

    if (remplies === 0) {
      alert("‚ùå Aucune complexit√© renseign√©e. La demande sera marqu√©e comme NON CHIFFR√âE.");
    }
  });

  // ‚úÖ Fermeture du modal sur ‚ÄúAnnuler‚Äù
  cancelBtn?.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  // ‚úÖ Validation du modal sur ‚ÄúContinuer‚Äù
  confirmBtn?.addEventListener("click", () => {
    modal.classList.add("hidden");
    shouldSubmit = true;
    form.submit();
  });

  // ‚úÖ Fermeture du modal en cliquant √† l‚Äôext√©rieur
  modal.addEventListener("click", (e) => {
    if (e.target === modal) modal.classList.add("hidden");
  });
});
    function updateComplexite(index) {
  const typeSelect = document.getElementById("type_c" + index);
  const valeurSelect = document.getElementById("valeur_c" + index);
  const libelle = valeurSelect.name.replace("complexite_", "");
  const type_libelle = typeSelect.value;
  const selectedValue = valeurSelect.value;

  if (!type_libelle) {
    valeurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
    return;
  }

  fetch("/demande_it/get_valeurs_complexite_it", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ libelle: libelle, type_libelle: type_libelle })
  })
    .then(response => response.json())
    .then(data => {
      valeurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      data.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.valeur_libelle;
        if (item.id.toString() === selectedValue) opt.selected = true;
        valeurSelect.appendChild(opt);
      });
    })
    .catch(err => console.error("Erreur AJAX:", err));
}

// === Valeurs m√©tier ===
function updateValeurs(index) {
  const typeSelect = document.getElementById("type_" + index);
  const valeurSelect = document.getElementById("valeur_" + index);
  const libelle = valeurSelect.form.action.split("libelle=")[1]; // r√©cup√®re le libell√© dans l‚ÄôURL
  const type_libelle = typeSelect.value;
  const selectedValue = valeurSelect.value;

  if (!type_libelle) {
    valeurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
    return;
  }

  fetch("/demande_it/get_valeurs_metier_it", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ libelle: decodeURIComponent(libelle), type_libelle })
  })
    .then(response => response.json())
    .then(data => {
      valeurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      data.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.valeur_libelle;
        if (item.id.toString() === selectedValue) opt.selected = true;
        valeurSelect.appendChild(opt);
      });
    })
    .catch(err => console.error("Erreur AJAX valeurs m√©tier:", err));
}
</script>
{% endblock %}


