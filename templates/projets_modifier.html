{% extends "base.html" %}
{% block title %}Modifier le Projet{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-8 py-10">
  <h1 class="text-3xl font-bold mb-6 text-blue-600">Modifier le Projet</h1>

  <!-- ============================= -->
  <!-- AFFICHAGE DES MESSAGES FLASH -->
  <!-- ============================= -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="px-4 py-3 rounded-lg text-white
                      {% if category == 'success' %}bg-green-600
                      {% elif category == 'error' %}bg-red-600
                      {% elif category == 'warning' %}bg-yellow-500
                      {% else %}bg-blue-500{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}


  <!-- ================================================== -->
  <!-- üîπ BLOC 1Ô∏è‚É£ : INFORMATIONS G√âN√âRALES DU PROJET -->
  <!-- ================================================== -->
  <form method="POST" class="bg-white shadow-md rounded-lg p-6 mb-10 border border-gray-200">
    <h2 class="text-2xl font-semibold text-blue-600 mb-4">Informations g√©n√©rales</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- üî∏ Titre -->
      <div>
        <label class="block font-medium text-gray-700 mb-1">Titre</label>
        <input type="text" name="titre" value="{{ projet.titre_projet }}"
               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
      </div>

      <!-- üî∏ Description -->
      <div>
        <label class="block font-medium text-gray-700 mb-1">Description</label>
        <textarea name="description" rows="2"
                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">{{ projet.description }}</textarea>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
      <!-- üî∏ Programme -->
      <div>
        <label class="block font-medium text-gray-700 mb-1">Programme</label>
        <select name="id_programme" onchange="loadPhasesProgramme()"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
          <option value="">-- S√©lectionner un programme --</option>
          {% for prog in programmes %}
            <option value="{{ prog.id }}" {% if prog.id == projet.id_programme %}selected{% endif %}>
              {{ prog.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- üî∏ Domaine -->
      <div>
        <label class="block font-medium text-gray-700 mb-1">Domaine</label>
        <select name="id_domaine"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
          <option value="">-- S√©lectionner un domaine --</option>
          {% for d in domaines %}
            <option value="{{ d.id }}" {% if d.id == projet.id_domaine %}selected{% endif %}>
              {{ d.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- üî∏ Cat√©gorie -->
      <div>
        <label class="block font-medium text-gray-700 mb-1">Cat√©gorie</label>
        <select name="id_categorie"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
          <option value="">-- S√©lectionner une cat√©gorie --</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if c.id == projet.id_categorie %}selected{% endif %}>
              {{ c.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- üî∏ Statut -->
      <div>
        <label class="block font-medium text-gray-700 mb-1">Statut</label>
        <select name="statut"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
          <option value="">-- S√©lectionner un statut --</option>
          {% for s in statuts %}
            <option value="{{ s.id }}" {% if s.id == projet.id_statut %}selected{% endif %}>
              {{ s.nom }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- üîπ Date MEP -->
    <div class="mt-6">
      <label class="block font-medium text-gray-700 mb-1">Date de mise en production (MEP)</label>
      <input type="date" name="date_mep" value="{{ projet.date_mep or '' }}"
             class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-blue-400 focus:border-blue-400">
    </div>

    <div class="mt-8">
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg">
        üíæ Enregistrer les informations du projet
      </button>
      <a href="{{ url_for('projet.liste_projets') }}"
         class="ml-4 text-blue-600 hover:underline">‚Üê Retour √† la liste</a>
    </div>
  </form>


  <!-- =================================================== -->
  <!-- üîπ BLOC 2Ô∏è‚É£ : PHASES DU PROJET (editable) -->
  <!-- =================================================== -->
  <form method="POST" action="{{ url_for('projet.update_phases_dates', projet_id=projet.id) }}"
        class="bg-white shadow-md rounded-lg border border-gray-200 mt-10">
    <h2 class="text-2xl font-semibold text-blue-600 px-6 pt-6 mb-4">Phases du projet</h2>

    <table class="min-w-full border border-gray-300 rounded-lg mb-6">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="px-4 py-2 text-left">Phase</th>
          <th class="px-4 py-2 text-center">Poids</th>
          <th class="px-4 py-2 text-center">Date d√©but</th>
          <th class="px-4 py-2 text-center">Date fin</th>
        </tr>
      </thead>
      <tbody id="phases-body">
  {% if phases_projet and phases_projet|length > 0 %}
    {% for p in phases_projet %}
      <tr class="border-b hover:bg-gray-50 text-gray-800">
        <td class="px-4 py-2 font-medium">{{ p.phase_nom }}</td>
        <td class="px-4 py-2 text-center">{{ "%.0f"|format(p.poids or 0) }}%</td>
        <td class="px-4 py-2 text-center">
          <input type="date" name="date_debut_{{ p.id }}" value="{{ p.date_debut }}"
                 class="border border-gray-300 rounded-lg px-2 py-1 focus:ring-blue-400 focus:border-blue-400">
        </td>
        <td class="px-4 py-2 text-center">
          <input type="date" name="date_fin_{{ p.id }}" value="{{ p.date_fin }}"
                 class="border border-gray-300 rounded-lg px-2 py-1 focus:ring-blue-400 focus:border-blue-400">
        </td>
      </tr>
    {% endfor %}
  {% else %}
    <tr><td colspan="4" class="text-center text-gray-500 py-4 italic">Aucune phase trouv√©e.</td></tr>
  {% endif %}
</tbody>

    </table>

    <div class="px-6 pb-6">
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg">
        üíæ Enregistrer les dates
      </button>
    </div>
  </form>


  <!-- =================================================== -->
  <!-- üîπ BLOC 3Ô∏è‚É£ : COMPLEXIT√â DU PROJET -->
  <!-- =================================================== -->
  <form method="POST" action="{{ url_for('projet.update_all_complexites', projet_id=projet.id) }}"
        class="bg-white shadow-md rounded-lg border border-gray-200 mt-10">
    <h2 class="text-2xl font-semibold text-blue-600 px-6 pt-6 mb-4">Complexit√© du projet</h2>

    <table class="min-w-full border border-gray-300 rounded-lg mb-6">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="px-4 py-2 text-left w-1/3">Libell√©</th>
          <th class="px-4 py-2 text-left w-1/3">Type</th>
          <th class="px-4 py-2 text-left w-1/3">Valeur</th>
        </tr>
      </thead>
      <tbody>
        {% for comp in complexites %}
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2 font-medium text-gray-800">{{ comp.libelle }}</td>
          <td class="px-4 py-2">
            <select id="type_c{{ loop.index }}" class="border border-gray-300 rounded-lg px-3 py-1 w-full"
                    onchange="updateComplexite('{{ loop.index }}')">
              <option value="">-- S√©lectionner --</option>
              {% for opt in dropdowns_complexite[comp.libelle] | groupby('type_libelle') %}
                <option value="{{ opt.grouper }}" {% if opt.grouper == comp.type_libelle %}selected{% endif %}>
                  {{ opt.grouper }}
                </option>
              {% endfor %}
            </select>
          </td>
          <td class="px-4 py-2">
            <select name="complexite_{{ comp.libelle }}" id="valeur_c{{ loop.index }}"
                    class="border border-gray-300 rounded-lg px-3 py-1 w-full">
              <option value="">-- S√©lectionner --</option>
              {% for option in dropdowns_complexite[comp.libelle] if option.type_libelle == comp.type_libelle %}
                <option value="{{ option.id }}" {% if option.id == comp.id_complexite %}selected{% endif %}>
                  {{ option.valeur_libelle }}
                </option>
              {% endfor %}
            </select>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="px-6 pb-6">
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg">
        üíæ Enregistrer toutes les complexit√©s
      </button>
    </div>
  </form>
</div>
<!--&lt;!&ndash; ===================================== &ndash;&gt;-->
<!--&lt;!&ndash; üîπ Bloc : Affectation des collaborateurs &ndash;&gt;-->
<!--&lt;!&ndash; ===================================== &ndash;&gt;-->
<!--<div class="bg-white shadow-md rounded-lg border border-gray-200 mt-10 p-6">-->
<!--  <h2 class="text-2xl font-semibold text-blue-600 mb-6">Collaborateurs affect√©s</h2>-->

<!--  &lt;!&ndash; Bouton Ajouter &ndash;&gt;-->
<!--  <div class="flex justify-end mb-4">-->
<!--    <button onclick="openAddModal()"-->
<!--            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow">-->
<!--      ‚ûï Ajouter un collaborateur-->
<!--    </button>-->
<!--  </div>-->

<!--  &lt;!&ndash; Tableau collaborateurs &ndash;&gt;-->
<!--  <table id="table-collaborateurs" class="min-w-full border border-gray-300 rounded-lg">-->
<!--    <thead class="bg-blue-600 text-white">-->
<!--      <tr>-->
<!--        <th class="px-4 py-2 text-left">Collaborateur</th>-->
<!--        <th class="px-4 py-2 text-left">R√¥le</th>-->
<!--        <th class="px-4 py-2 text-center">% Allocation</th>-->
<!--        <th class="px-4 py-2 text-center">Actions</th>-->
<!--      </tr>-->
<!--    </thead>-->
<!--    <tbody>-->
<!--      {% for a in affectations %}-->
<!--      <tr data-id="{{ a.id }}" class="hover:bg-gray-50">-->
<!--        <td class="px-4 py-2">{{ a.collaborateur }}</td>-->
<!--        <td class="px-4 py-2">-->
<!--          <input type="text" class="border rounded px-2 py-1 w-full text-sm" value="{{ a.role }}">-->
<!--        </td>-->
<!--        <td class="px-4 py-2 text-center">-->
<!--          <input type="number" class="border rounded px-2 py-1 w-20 text-center" min="0" max="100"-->
<!--                 value="{{ a.pourcentage_allocation }}">-->
<!--        </td>-->
<!--        <td class="px-4 py-2 text-center">-->
<!--          <button class="update-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded">üíæ</button>-->
<!--          <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">üóëÔ∏è</button>-->
<!--        </td>-->
<!--      </tr>-->
<!--      {% else %}-->
<!--      <tr><td colspan="4" class="text-center text-gray-500 py-4 italic">Aucun collaborateur affect√©.</td></tr>-->
<!--      {% endfor %}-->
<!--    </tbody>-->
<!--  </table>-->
<!--</div>-->

<!--&lt;!&ndash; üîπ Modal ajout collaborateur &ndash;&gt;-->
<!--<div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">-->
<!--  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">-->
<!--    <h2 class="text-xl font-semibold text-blue-600 mb-4">Ajouter un collaborateur</h2>-->
<!--    <form id="addCollabForm">-->
<!--      <div class="mb-4">-->
<!--        <label class="block font-medium text-gray-700 mb-1">Collaborateur</label>-->
<!--        <select name="collaborateur" required class="w-full border rounded-lg px-3 py-2">-->
<!--          <option value="">&#45;&#45; S√©lectionner &#45;&#45;</option>-->
<!--          {% for c in collaborateurs %}-->
<!--            <option value="{{ c.matricule }}">{{ c.nom_complet }}</option>-->
<!--          {% endfor %}-->
<!--        </select>-->
<!--      </div>-->
<!--      <div class="mb-4">-->
<!--        <label class="block font-medium text-gray-700 mb-1">R√¥le</label>-->
<!--        <input type="text" name="role" class="w-full border rounded-lg px-3 py-2" placeholder="Ex: D√©veloppeur">-->
<!--      </div>-->
<!--      <div class="mb-6">-->
<!--        <label class="block font-medium text-gray-700 mb-1">% Allocation</label>-->
<!--        <input type="number" name="pourcentage" min="0" max="100" class="w-full border rounded-lg px-3 py-2" placeholder="Ex: 50">-->
<!--      </div>-->
<!--      <div class="flex justify-end space-x-3">-->
<!--        <button type="button" onclick="closeAddModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Annuler</button>-->
<!--        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ajouter</button>-->
<!--      </div>-->
<!--    </form>-->
<!--  </div>-->
<!--</div>-->

<script>
// ============================
// üîπ Gestion du modal collaborateur
// ============================
function openAddModal() {
  document.getElementById('addModal').classList.remove('hidden');
}
function closeAddModal() {
  document.getElementById('addModal').classList.add('hidden');
}

// ============================
// üîπ AJOUT D‚ÄôUN COLLABORATEUR
// ============================
document.getElementById('addCollabForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const projetId = {{ projet.id }};
  const formData = new FormData(this);

  const res = await fetch(`/projet/${projetId}/ajouter_collaborateur`, {
    method: 'POST',
    body: formData
  });
  const data = await res.json();

  if (data.success) {
    location.reload();
  } else {
    alert(data.message);
  }
});

// ============================
// üîπ MODIFICATION D‚ÄôUN COLLABORATEUR
// ============================
document.querySelectorAll('.update-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const row = btn.closest('tr');
    const id = row.dataset.id;
    const role = row.querySelector('input[type="text"]').value;
    const pourcentage = row.querySelector('input[type="number"]').value;

    const formData = new FormData();
    formData.append('role', role);
    formData.append('pourcentage', pourcentage);

    const res = await fetch(`/projet/modifier_collaborateur/${id}`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      btn.classList.add('bg-green-700');
      setTimeout(() => btn.classList.remove('bg-green-700'), 600);
    } else {
      alert(data.message);
    }
  });
});

// ============================
// üîπ SUPPRESSION D‚ÄôUN COLLABORATEUR
// ============================
document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    if (!confirm('Supprimer ce collaborateur ?')) return;
    const row = btn.closest('tr');
    const id = row.dataset.id;

    const res = await fetch(`/projet/supprimer_collaborateur/${id}`, { method: 'POST' });
    const data = await res.json();

    if (data.success) row.remove();
    else alert(data.message);
  });
});

// ============================
// üîπ MISE √Ä JOUR DES VALEURS DE COMPLEXIT√â
// ============================
async function updateComplexite(index) {
  const typeSelect = document.getElementById(`type_c${index}`);
  const valeurSelect = document.getElementById(`valeur_c${index}`);
  const libelle = typeSelect.closest("tr").querySelector("td").textContent.trim();
  const type_libelle = typeSelect.value;

  if (!type_libelle) {
    valeurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
    return;
  }

  try {
    const res = await fetch("/projet/get_valeurs_complexite", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ libelle, type_libelle })
    });
    const data = await res.json();

    valeurSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
    data.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.id;
      opt.textContent = item.valeur_libelle;
      valeurSelect.appendChild(opt);
    });
  } catch (err) {
    console.error("Erreur AJAX updateComplexite:", err);
  }
}

// ============================
// üîπ CHARGEMENT DYNAMIQUE DES PHASES DU PROGRAMME
// ============================
window.loadPhasesProgramme = async function () {
  const select = document.querySelector('select[name="id_programme"]');
  const programmeId = select.value;

  const tbody = document.getElementById("phases-body");
  tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4 italic">
    Chargement des phases...
  </td></tr>`;

  if (!programmeId) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4 italic">
      Aucune phase ‚Äî veuillez choisir un programme.
    </td></tr>`;
    return;
  }

  try {
    const res = await fetch(`/projet/phases_programme/${programmeId}?projet_id={{ projet.id }}`);
    const data = await res.json();

    if (!data.success) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-yellow-600 py-4 font-semibold">
        ${data.message}
      </td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    data.phases.forEach(p => {
      tbody.innerHTML += `
        <tr class="border-b hover:bg-gray-50 text-gray-800">
          <td class="px-4 py-2 font-medium">${p.phase_nom}</td>
          <td class="px-4 py-2 text-center">${p.poids}%</td>
          <td class="px-4 py-2 text-center"><input type="date" value="${p.date_debut}" /></td>
          <td class="px-4 py-2 text-center"><input type="date" value="${p.date_fin}" /></td>
        </tr>`;
    });
  } catch (err) {
    console.error("Erreur JS loadPhasesProgramme:", err);
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4 italic">
      Erreur lors du chargement des phases.
    </td></tr>`;
  }
};
</script>


{% endblock %}
