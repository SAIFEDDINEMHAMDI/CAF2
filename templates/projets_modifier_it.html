{% extends "base.html" %}
{% block title %}Modifier le Projet{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-8 py-10">
  <h1 class="text-3xl font-bold mb-6 text-blue-600">Modifier le Projet IT</h1>

  <!-- ============================= -->
  <!-- AFFICHAGE DES MESSAGES FLASH -->
  <!-- ============================= -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="px-4 py-3 rounded-lg text-white
                      {% if category == 'success' %}bg-green-600
                      {% elif category == 'error' %}bg-red-600
                      {% elif category == 'warning' %}bg-yellow-500
                      {% else %}bg-blue-500{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}


<!-- ================================================== -->
<!-- üîπ BLOC 1Ô∏è‚É£ : INFORMATIONS G√âN√âRALES DU PROJET (lecture seule) -->
<!-- ================================================== -->
<div class="bg-white shadow-md rounded-lg p-6 mb-10 border border-gray-200">
  <h2 class="text-2xl font-semibold text-blue-600 mb-4">Informations g√©n√©rales</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- üî∏ Titre -->
    <div>
      <label class="block font-medium text-gray-700 mb-1">Titre</label>
      <input type="text" value="{{ projet.titre_projet }}"
             readonly
             class="w-full border border-gray-300 bg-gray-100 rounded-lg px-4 py-2 text-gray-700">
    </div>

    <!-- üî∏ Description -->
    <div>
      <label class="block font-medium text-gray-700 mb-1">Description</label>
      <textarea rows="2" readonly
                class="w-full border border-gray-300 bg-gray-100 rounded-lg px-4 py-2 text-gray-700">{{ projet.description }}</textarea>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
    <!-- üî∏ Programme -->
    <div>
      <label class="block font-medium text-gray-700 mb-1">Programme</label>
      <input type="text" value="{{ projet.programme_nom or '-' }}"
             readonly
             class="w-full border border-gray-300 bg-gray-100 rounded-lg px-4 py-2 text-gray-700">
    </div>

    <!-- üî∏ Domaine -->
    <div>
      <label class="block font-medium text-gray-700 mb-1">Domaine</label>
      <input type="text" value="{{ projet.domaine_nom or '-' }}"
             readonly
             class="w-full border border-gray-300 bg-gray-100 rounded-lg px-4 py-2 text-gray-700">
    </div>
     <!-- üîπ Date MEP -->
    <div>
    <label class="block font-medium text-gray-700 mb-1">Date de mise en production (MEP)</label>
    <input type="date" value="{{ projet.date_mep or '' }}"
           readonly
           class="border border-gray-300 bg-gray-100 rounded-lg px-4 py-2 text-gray-700">
    </div>

  </div>



  <div class="mt-8">
    <a href="{{ url_for('demande_it.liste_projets_it') }}"
       class="text-blue-600 hover:underline">‚Üê Retour √† la liste</a>
  </div>
</div>



  <!-- =================================================== -->
  <!-- üîπ BLOC 2Ô∏è‚É£ : PHASES DU PROJET (editable) -->
  <!-- =================================================== -->
  <form method="POST" action="{{ url_for('demande_it.update_phases_dates_it', projet_id=projet.id) }}"
        class="bg-white shadow-md rounded-lg border border-gray-200 mt-10">
    <h2 class="text-2xl font-semibold text-blue-600 px-6 pt-6 mb-4">Phases du projet</h2>

    <table class="min-w-full border border-gray-300 rounded-lg mb-6">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="px-4 py-2 text-left">Phase</th>
          <th class="px-4 py-2 text-center">Poids</th>
          <th class="px-4 py-2 text-center">Date d√©but</th>
          <th class="px-4 py-2 text-center">Date fin</th>
        </tr>
      </thead>
      <tbody id="phases-body">
  {% if phases_projet and phases_projet|length > 0 %}
    {% for p in phases_projet %}
      <tr class="border-b hover:bg-gray-50 text-gray-800">
        <td class="px-4 py-2 font-medium">{{ p.phase_nom }}</td>
        <td class="px-4 py-2 text-center">{{ "%.0f"|format(p.poids or 0) }}%</td>
        <td class="px-4 py-2 text-center">
          <input type="date" name="date_debut_{{ p.id }}" value="{{ p.date_debut }}"
                 class="border border-gray-300 rounded-lg px-2 py-1 focus:ring-blue-400 focus:border-blue-400">
        </td>
        <td class="px-4 py-2 text-center">
          <input type="date" name="date_fin_{{ p.id }}" value="{{ p.date_fin }}"
                 class="border border-gray-300 rounded-lg px-2 py-1 focus:ring-blue-400 focus:border-blue-400">
        </td>
      </tr>
    {% endfor %}
  {% else %}
    <tr><td colspan="4" class="text-center text-gray-500 py-4 italic">Aucune phase trouv√©e.</td></tr>
  {% endif %}
</tbody>

    </table>

    <div class="px-6 pb-6">
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg shadow-lg">
        üíæ Enregistrer les dates
      </button>
    </div>
  </form>


{% endblock %}
{% block scripts %}
<script>

document.addEventListener("DOMContentLoaded", () => {
  // ============================
  // üîπ CHARGEMENT DYNAMIQUE DES PHASES DU PROGRAMME
  // ============================
  async function loadPhasesProgramme() {
    const select = document.querySelector('select[name="id_programme"]');
    const programmeId = select?.value;
    const tbody = document.getElementById("phases-body");

    if (!tbody) return;
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4 italic">
      Chargement des phases...
    </td></tr>`;

    if (!programmeId) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4 italic">
        Aucune phase ‚Äî veuillez choisir un programme.
      </td></tr>`;
      return;
    }

    try {
      const res = await fetch(`/demande_it/phases_programme_it/${programmeId}?projet_id={{ projet.id }}`);
      const data = await res.json();

      if (!data.success) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-yellow-600 py-4 font-semibold">
          ${data.message}
        </td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      data.phases.forEach(p => {
        tbody.insertAdjacentHTML("beforeend", `
          <tr class="border-b hover:bg-gray-50 text-gray-800">
            <td class="px-4 py-2 font-medium">${p.phase_nom}</td>
            <td class="px-4 py-2 text-center">${p.poids}%</td>
            <td class="px-4 py-2 text-center">
              <input type="date" value="${p.date_debut}" class="border border-gray-300 rounded-lg px-2 py-1">
            </td>
            <td class="px-4 py-2 text-center">
              <input type="date" value="${p.date_fin}" class="border border-gray-300 rounded-lg px-2 py-1">
            </td>
          </tr>
        `);
      });
    } catch (err) {
      console.error("‚ùå Erreur JS loadPhasesProgramme:", err);
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4 italic">
        Erreur lors du chargement des phases.
      </td></tr>`;
    }
  }

  // ‚úÖ Ajoute l‚Äô√©couteur sur le select programme
  const select = document.querySelector('select[name="id_programme"]');
  if (select) {
    select.addEventListener("change", loadPhasesProgramme);
    if (select.value) loadPhasesProgramme(); // auto-chargement si programme d√©j√† choisi
  }
});
</script>
{% endblock %}
